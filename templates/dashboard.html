{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - CropAdvisor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <h1 class="welcome-message">Welcome back, <span>{{ user.username|default:"User" }}</span>!</h1>
            <p class="dashboard-subtitle">Enter your soil and climate data to get personalized crop recommendations.</p>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-main">
                <div class="input-form-card">
                    <h2 class="form-title">
                        <span class="form-title-icon">ğŸŒ±</span>
                        Soil & Climate Parameters
                    </h2>
                    
                    <div class="form-helper-text">
                        ğŸŒ¤ Climate values (Temperature, Humidity, Rainfall) are auto-detected.
                        <br>
                        ğŸŒ¾ Please adjust soil parameters (N, P, K, pH) based on your soil test report for accurate recommendations.
                    </div>

                    <form id="prediction-form" method="POST">
                        {% csrf_token %}
                        <div class="slider-grid">
                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="nitrogen">Nitrogen (N)</label>
                                    <span class="slider-value" id="nitrogen-value">50 kg/ha</span>
                                </div>
                                <input type="range" id="nitrogen" name="nitrogen" class="slider-input" min="0" max="140" value="50" data-unit=" kg/ha" data-default="50">
                                <div class="slider-range"><span>0</span><span>140</span></div>
                            </div>

                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="phosphorus">Phosphorus (P)</label>
                                    <span class="slider-value" id="phosphorus-value">50 kg/ha</span>
                                </div>
                                <input type="range" id="phosphorus" name="phosphorus" class="slider-input" min="5" max="145" value="50" data-unit=" kg/ha" data-default="50">
                                <div class="slider-range"><span>5</span><span>145</span></div>
                            </div>

                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="potassium">Potassium (K)</label>
                                    <span class="slider-value" id="potassium-value">50 kg/ha</span>
                                </div>
                                <input type="range" id="potassium" name="potassium" class="slider-input" min="5" max="205" value="50" data-unit=" kg/ha" data-default="50">
                                <div class="slider-range"><span>5</span><span>205</span></div>
                            </div>

                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="temperature">Temperature</label>
                                    <span class="slider-value" id="temperature-value">25Â°C</span>
                                </div>
                                <input type="range" id="temperature" name="temperature" class="slider-input" min="8" max="44" value="25" step="0.5" data-unit="Â°C" data-default="25">
                                <div class="slider-range"><span>8Â°C</span><span>44Â°C</span></div>
                            </div>

                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="humidity">Humidity</label>
                                    <span class="slider-value" id="humidity-value">50%</span>
                                </div>
                                <input type="range" id="humidity" name="humidity" class="slider-input" min="14" max="100" value="50" step="0.5" data-unit="%" data-default="50">
                                <div class="slider-range"><span>14%</span><span>100%</span></div>
                            </div>

                            <div class="slider-group">
                                <div class="slider-header">
                                    <label class="slider-label" for="rainfall">Rainfall</label>
                                    <span class="slider-value" id="rainfall-value">100 mm</span>
                                </div>
                                <input type="range" id="rainfall" name="rainfall" class="slider-input" min="20" max="300" value="100" data-unit=" mm" data-default="100">
                                <div class="slider-range"><span>20 mm</span><span>300 mm</span></div>
                            </div>

                            <div class="slider-group" style="grid-column: span 2;">
                                <div class="slider-header">
                                    <label class="slider-label" for="ph">Soil pH</label>
                                    <span class="slider-value" id="ph-value">6.5</span>
                                </div>
                                <input type="range" id="ph" name="ph" class="slider-input" min="3.5" max="10" value="6.5" step="0.1" data-unit="" data-default="6.5">
                                <div class="slider-range"><span>3.5 (Acidic)</span><span>10 (Alkaline)</span></div>
                            </div>
                        </div>

                        <div class="form-submit">
                            <button type="submit" class="submit-btn">ğŸŒ¾ Get Crop Recommendation</button>
                        </div>
                    </form>
                </div>

                <div class="results-card">
                    <h2 class="results-title"><span>ğŸ“Š</span> Recommendation Results</h2>
                    <div id="results-container">
                        <div id="results-placeholder" class="results-placeholder">
                            <div class="results-placeholder-icon">ğŸŒ±</div>
                            <p>Enter your soil and climate data, then click "Get Crop Recommendation" to see results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-sidebar">
                <div class="chart-card">
                    <h2 class="chart-title"><span>ğŸ“ˆ</span> Feature Importance</h2>
                    <div class="chart-container">
                        <canvas id="feature-importance-chart"></canvas>
                    </div>
                </div>
            </div>           
        </div>

        <div class="history-card" style="margin-top: 24px;">
            <h2 class="history-title">
                <span>ğŸ“œ</span> Prediction History
                <button id="reset-history-btn" class="reset-btn">Clear All</button>
            </h2>
            <div class="table-wrapper">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Top Recommendation</th>
                            <th>Confidence</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr><td colspan="4" class="empty-history">Loading prediction history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="history-card" style="margin-top: 24px;">
            <h2 class="history-title">ğŸ“Š My Crop Insights</h2>
            <div id="insights-summary" class="insights-summary">Loading insights...</div>
            <div class="chart-grid" style="margin-top: 20px;">
                <div class="chart-card">
                    <h3>ğŸŒ¾ Crop Frequency</h3>
                    <div class="chart-container"><canvas id="cropFrequencyChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ¯ Confidence Distribution</h3>
                    <div class="chart-container"><canvas id="confidenceChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="agro-news-section" style="margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 40px;">
            <h2 class="news-title">Latest Agriculture News</h2>
            <div class="news-carousel">
                <button class="carousel-btn left-btn" onclick="prevNews()">â®</button>
                <div class="news-slider-wrapper">
                    <div id="news-container" class="news-slider">Loading agriculture news...</div>
                </div>
                <button class="carousel-btn right-btn" onclick="nextNews()">â¯</button>
            </div>
        </div>

        <div class="learn-cta-container" style="margin-top: 40px;">
            <div class="learn-cta-card">
                <div class="learn-cta-content">
                    <div class="learn-cta-text">
                        <h3>Elevate Your Farming Skills</h3>
                        <p>Access curated tutorials, government schemes, and modern agri-tech guides.</p>
                    </div>
                    <a href="/learn/" class="learn-cta-button">
                        <span>Start Learning</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </a>
                </div>
                <div class="learn-cta-visual">ğŸŒ¾</div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/slider.js' %}"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}